{% extends 'base.html' %}
{% block title %}{{ 'Edit' if edit else 'Tambah' }} Data Kepindahan{% endblock %}

{% block content %}
<div class="page-title">
  <div class="title_left"><h3>{{ 'Edit' if edit else 'Tambah' }} Data Kepindahan</h3></div>
</div>
<div class="clearfix"></div>

<div class="row">
  <div class="col-md-12 col-sm-12">
    <div class="x_panel">
      <div class="x_title">
        <h2>Form Kepindahan</h2>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <form method="POST" autocomplete="off" action="{{ url_for('kepindahan.edit', id=data.id) if edit else url_for('kepindahan.tambah') }}">
          
          <div class="form-group">
            <label for="nik">NIK</label>
            <input type="text" name="nik" id="nik" class="form-control" required
                   value="{{ data.nik if edit else '' }}">
          </div>

          <div class="form-group">
            <label>Nama</label>
            <input type="text" name="nama" id="nama" class="form-control" readonly
                   value="{{ data.nama if edit else '' }}">
          </div>

          <div class="form-group">
            <label>Tanggal Pindah</label>
            <input type="date" name="tanggal_pindah" class="form-control" required
                   value="{{ data.tanggal_pindah if edit else '' }}">
          </div>

          <div class="form-group">
            <label>Keterangan</label>
            <textarea name="keterangan" class="form-control" rows="3">{{ data.keterangan if edit else '' }}</textarea>
          </div>

          <button type="submit" class="btn btn-success">
            <i class="fa fa-save"></i> {{ 'Simpan Perubahan' if edit else 'Simpan' }}
          </button>
          <a href="{{ url_for('kepindahan.index') }}" class="btn btn-secondary">
            <i class="fa fa-arrow-left"></i> Kembali
          </a>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- jQuery UI -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<script>
  $(function () {
    $('#nik').autocomplete({
      source: function (request, response) {
        $.ajax({
          url: "{{ url_for('kematian.cari_nik') }}",  // gunakan endpoint autocomplete dari kematian (sudah tersedia)
          data: { term: request.term },
          success: function (data) {
            response(data);
          }
        });
      },
      minLength: 2,
      select: function (event, ui) {
        const selected = ui.item.value;
        const nik = selected.split(' - ')[0];
        $('#nik').val(nik).trigger('change');
        return false;
      }
    });

    $('#nik').on('change', function () {
      const nik = $(this).val();
      if (nik.length >= 10) {
        $.getJSON(`/kepindahan/penduduk/${nik}`, function (data) {
          $('#nama').val(data.nama || '');
        }).fail(function () {
          $('#nama').val('');
        });
      }
    });
  });
</script>
{% endblock %}
